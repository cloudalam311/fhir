"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NagSuppressionHelper = void 0;
/*
Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0
*/
const aws_cdk_lib_1 = require("aws-cdk-lib");
class NagSuppressionHelper {
    static toCfnFormat(suppression) {
        const { appliesTo, ...result } = suppression;
        if (appliesTo) {
            result.applies_to = appliesTo;
        }
        return result;
    }
    static toApiFormat(suppression) {
        const { applies_to, ...result } = suppression;
        if (applies_to) {
            result.appliesTo = applies_to;
        }
        return result;
    }
    static addRulesToMetadata(metadata, rules) {
        const { rules_to_suppress } = metadata !== null && metadata !== void 0 ? metadata : {};
        const serialisedRules = [
            ...(rules_to_suppress !== null && rules_to_suppress !== void 0 ? rules_to_suppress : []).map((r) => JSON.stringify(r)),
            ...rules
                .map(NagSuppressionHelper.toCfnFormat)
                .map((r) => JSON.stringify(r)),
        ];
        const deduplicatedRules = Array.from(new Set(serialisedRules));
        return { rules_to_suppress: deduplicatedRules.map((r) => JSON.parse(r)) };
    }
    static getSuppressions(node) {
        var _a, _b, _c, _d, _e;
        const resourceIgnores = (_b = (_a = node.getMetadata('cdk_nag')) === null || _a === void 0 ? void 0 : _a.rules_to_suppress) !== null && _b !== void 0 ? _b : [];
        const stackIgnores = (_e = (_d = (_c = aws_cdk_lib_1.Stack.of(node).templateOptions.metadata) === null || _c === void 0 ? void 0 : _c.cdk_nag) === null || _d === void 0 ? void 0 : _d.rules_to_suppress) !== null && _e !== void 0 ? _e : [];
        const result = [...resourceIgnores, ...stackIgnores].map(NagSuppressionHelper.toApiFormat);
        NagSuppressionHelper.assertSuppressionsAreValid(node.node.id, result);
        return result;
    }
    static assertSuppressionsAreValid(id, suppressions) {
        const errors = suppressions
            .map(NagSuppressionHelper.getSuppressionFormatError)
            .filter((errorMessage) => !!errorMessage);
        if (errors.length) {
            throw Error(`${id}: ${errors.join('')}\nSee https://github.com/cdklabs/cdk-nag#suppressing-a-rule for information on suppressing a rule.`);
        }
    }
    static doesApply(suppression, ruleId, findingId) {
        if (ruleId !== suppression.id) {
            return false;
        }
        if (!suppression.appliesTo) {
            // the rule is not granular so it always applies
            return true;
        }
        if (findingId &&
            suppression.appliesTo.some((appliesTo) => {
                if (typeof appliesTo === 'string') {
                    return appliesTo === findingId;
                }
                else {
                    const regex = NagSuppressionHelper.toRegEx(appliesTo.regex);
                    return regex.test(findingId);
                }
            })) {
            return true;
        }
        return false;
    }
    static getSuppressionFormatError(suppression) {
        var _a;
        let errors = '';
        const finding = suppression.id.match(/\[.*\]/);
        if (finding) {
            errors += `The suppression 'id' contains a finding '${finding}. A finding must be suppressed using 'applies_to'.`;
        }
        if (suppression.reason.length < 10) {
            errors +=
                "The suppression must have a 'reason' of 10 characters or more.";
        }
        ((_a = suppression.appliesTo) !== null && _a !== void 0 ? _a : []).forEach((appliesTo) => {
            if (typeof appliesTo !== 'string') {
                try {
                    NagSuppressionHelper.toRegEx(appliesTo.regex);
                }
                catch (err) {
                    errors += err.message;
                }
            }
        });
        return errors
            ? `\n\tError(s) detected in suppression with 'id' ${suppression.id}. ${errors}`
            : '';
    }
    static toRegEx(s) {
        try {
            // verify that the regex is correctly formatted
            const m = s.match(/\/(.*)\/(.*)?/);
            if (!m) {
                throw new Error();
            }
            return new RegExp(m[1], m[2] || '');
        }
        catch {
            throw new Error(`Invalid regular expression [${s}]`);
        }
    }
}
exports.NagSuppressionHelper = NagSuppressionHelper;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmFnLXN1cHByZXNzaW9uLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9uYWctc3VwcHJlc3Npb24taGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBOzs7RUFHRTtBQUNGLDZDQUFpRDtBQWNqRCxNQUFhLG9CQUFvQjtJQUMvQixNQUFNLENBQUMsV0FBVyxDQUFDLFdBQStCO1FBQ2hELE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLEVBQUUsR0FBRyxXQUFXLENBQUM7UUFFN0MsSUFBSSxTQUFTLEVBQUU7WUFDWixNQUE0QixDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7U0FDdEQ7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUE4QjtRQUMvQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDO1FBRTlDLElBQUksVUFBVSxFQUFFO1lBQ2IsTUFBYyxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUM7U0FDeEM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUN2QixRQUF3QixFQUN4QixLQUEyQjtRQUUzQixNQUFNLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxFQUFFLENBQUM7UUFDN0MsTUFBTSxlQUFlLEdBQUc7WUFDdEIsR0FBRyxDQUFDLGlCQUFpQixhQUFqQixpQkFBaUIsY0FBakIsaUJBQWlCLEdBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFELEdBQUcsS0FBSztpQkFDTCxHQUFHLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDO2lCQUNyQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakMsQ0FBQztRQUNGLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1FBQy9ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzVFLENBQUM7SUFFRCxNQUFNLENBQUMsZUFBZSxDQUFDLElBQWlCOztRQUN0QyxNQUFNLGVBQWUsZUFDbkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsMENBQUUsaUJBQWlCLG1DQUFJLEVBQUUsQ0FBQztRQUN2RCxNQUFNLFlBQVkscUJBQ2hCLG1CQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxRQUFRLDBDQUFFLE9BQU8sMENBQUUsaUJBQWlCLG1DQUFJLEVBQUUsQ0FBQztRQUM1RSxNQUFNLE1BQU0sR0FBRyxDQUFDLEdBQUcsZUFBZSxFQUFFLEdBQUcsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUN0RCxvQkFBb0IsQ0FBQyxXQUFXLENBQ2pDLENBQUM7UUFDRixvQkFBb0IsQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN0RSxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLDBCQUEwQixDQUMvQixFQUFVLEVBQ1YsWUFBa0M7UUFFbEMsTUFBTSxNQUFNLEdBQUcsWUFBWTthQUN4QixHQUFHLENBQUMsb0JBQW9CLENBQUMseUJBQXlCLENBQUM7YUFDbkQsTUFBTSxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFNUMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ2pCLE1BQU0sS0FBSyxDQUNULEdBQUcsRUFBRSxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQ25CLEVBQUUsQ0FDSCxvR0FBb0csQ0FDdEcsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQ2QsV0FBK0IsRUFDL0IsTUFBYyxFQUNkLFNBQWlCO1FBRWpCLElBQUksTUFBTSxLQUFLLFdBQVcsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFO1lBQzFCLGdEQUFnRDtZQUNoRCxPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsSUFDRSxTQUFTO1lBQ1QsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDdkMsSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7b0JBQ2pDLE9BQU8sU0FBUyxLQUFLLFNBQVMsQ0FBQztpQkFDaEM7cUJBQU07b0JBQ0wsTUFBTSxLQUFLLEdBQUcsb0JBQW9CLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDNUQsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUM5QjtZQUNILENBQUMsQ0FBQyxFQUNGO1lBQ0EsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLE1BQU0sQ0FBQyx5QkFBeUIsQ0FDdEMsV0FBK0I7O1FBRS9CLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNoQixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMvQyxJQUFJLE9BQU8sRUFBRTtZQUNYLE1BQU0sSUFBSSw0Q0FBNEMsT0FBTyxvREFBb0QsQ0FBQztTQUNuSDtRQUNELElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsRUFBRSxFQUFFO1lBQ2xDLE1BQU07Z0JBQ0osZ0VBQWdFLENBQUM7U0FDcEU7UUFDRCxPQUFDLFdBQVcsQ0FBQyxTQUFTLG1DQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ2xELElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFFO2dCQUNqQyxJQUFJO29CQUNGLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQy9DO2dCQUFDLE9BQU8sR0FBRyxFQUFFO29CQUNaLE1BQU0sSUFBSyxHQUFhLENBQUMsT0FBTyxDQUFDO2lCQUNsQzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE1BQU07WUFDWCxDQUFDLENBQUMsa0RBQWtELFdBQVcsQ0FBQyxFQUFFLEtBQUssTUFBTSxFQUFFO1lBQy9FLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDVCxDQUFDO0lBRU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFTO1FBQzlCLElBQUk7WUFDRiwrQ0FBK0M7WUFDL0MsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsQ0FBQyxFQUFFO2dCQUNOLE1BQU0sSUFBSSxLQUFLLEVBQUUsQ0FBQzthQUNuQjtZQUNELE9BQU8sSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNyQztRQUFDLE1BQU07WUFDTixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3REO0lBQ0gsQ0FBQztDQUNGO0FBcElELG9EQW9JQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cblNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4qL1xuaW1wb3J0IHsgQ2ZuUmVzb3VyY2UsIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHtcbiAgTmFnUGFja1N1cHByZXNzaW9uLFxuICBOYWdQYWNrU3VwcHJlc3Npb25BcHBsaWVzVG8sXG59IGZyb20gJy4uL21vZGVscy9uYWctc3VwcHJlc3Npb24nO1xuXG5pbnRlcmZhY2UgTmFnQ2ZuTWV0YWRhdGEge1xuICBydWxlc190b19zdXBwcmVzczogTmFnQ2ZuU3VwcHJlc3Npb25bXTtcbn1cblxuaW50ZXJmYWNlIE5hZ0NmblN1cHByZXNzaW9uIGV4dGVuZHMgT21pdDxOYWdQYWNrU3VwcHJlc3Npb24sICdhcHBsaWVzVG8nPiB7XG4gIGFwcGxpZXNfdG8/OiBOYWdQYWNrU3VwcHJlc3Npb25BcHBsaWVzVG9bXTtcbn1cblxuZXhwb3J0IGNsYXNzIE5hZ1N1cHByZXNzaW9uSGVscGVyIHtcbiAgc3RhdGljIHRvQ2ZuRm9ybWF0KHN1cHByZXNzaW9uOiBOYWdQYWNrU3VwcHJlc3Npb24pOiBOYWdDZm5TdXBwcmVzc2lvbiB7XG4gICAgY29uc3QgeyBhcHBsaWVzVG8sIC4uLnJlc3VsdCB9ID0gc3VwcHJlc3Npb247XG5cbiAgICBpZiAoYXBwbGllc1RvKSB7XG4gICAgICAocmVzdWx0IGFzIE5hZ0NmblN1cHByZXNzaW9uKS5hcHBsaWVzX3RvID0gYXBwbGllc1RvO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIHRvQXBpRm9ybWF0KHN1cHByZXNzaW9uOiBOYWdDZm5TdXBwcmVzc2lvbik6IE5hZ1BhY2tTdXBwcmVzc2lvbiB7XG4gICAgY29uc3QgeyBhcHBsaWVzX3RvLCAuLi5yZXN1bHQgfSA9IHN1cHByZXNzaW9uO1xuXG4gICAgaWYgKGFwcGxpZXNfdG8pIHtcbiAgICAgIChyZXN1bHQgYXMgYW55KS5hcHBsaWVzVG8gPSBhcHBsaWVzX3RvO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIGFkZFJ1bGVzVG9NZXRhZGF0YShcbiAgICBtZXRhZGF0YTogTmFnQ2ZuTWV0YWRhdGEsXG4gICAgcnVsZXM6IE5hZ1BhY2tTdXBwcmVzc2lvbltdXG4gICk6IE5hZ0Nmbk1ldGFkYXRhIHtcbiAgICBjb25zdCB7IHJ1bGVzX3RvX3N1cHByZXNzIH0gPSBtZXRhZGF0YSA/PyB7fTtcbiAgICBjb25zdCBzZXJpYWxpc2VkUnVsZXMgPSBbXG4gICAgICAuLi4ocnVsZXNfdG9fc3VwcHJlc3MgPz8gW10pLm1hcCgocikgPT4gSlNPTi5zdHJpbmdpZnkocikpLFxuICAgICAgLi4ucnVsZXNcbiAgICAgICAgLm1hcChOYWdTdXBwcmVzc2lvbkhlbHBlci50b0NmbkZvcm1hdClcbiAgICAgICAgLm1hcCgocikgPT4gSlNPTi5zdHJpbmdpZnkocikpLFxuICAgIF07XG4gICAgY29uc3QgZGVkdXBsaWNhdGVkUnVsZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoc2VyaWFsaXNlZFJ1bGVzKSk7XG4gICAgcmV0dXJuIHsgcnVsZXNfdG9fc3VwcHJlc3M6IGRlZHVwbGljYXRlZFJ1bGVzLm1hcCgocikgPT4gSlNPTi5wYXJzZShyKSkgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRTdXBwcmVzc2lvbnMobm9kZTogQ2ZuUmVzb3VyY2UpOiBOYWdQYWNrU3VwcHJlc3Npb25bXSB7XG4gICAgY29uc3QgcmVzb3VyY2VJZ25vcmVzID1cbiAgICAgIG5vZGUuZ2V0TWV0YWRhdGEoJ2Nka19uYWcnKT8ucnVsZXNfdG9fc3VwcHJlc3MgPz8gW107XG4gICAgY29uc3Qgc3RhY2tJZ25vcmVzID1cbiAgICAgIFN0YWNrLm9mKG5vZGUpLnRlbXBsYXRlT3B0aW9ucy5tZXRhZGF0YT8uY2RrX25hZz8ucnVsZXNfdG9fc3VwcHJlc3MgPz8gW107XG4gICAgY29uc3QgcmVzdWx0ID0gWy4uLnJlc291cmNlSWdub3JlcywgLi4uc3RhY2tJZ25vcmVzXS5tYXAoXG4gICAgICBOYWdTdXBwcmVzc2lvbkhlbHBlci50b0FwaUZvcm1hdFxuICAgICk7XG4gICAgTmFnU3VwcHJlc3Npb25IZWxwZXIuYXNzZXJ0U3VwcHJlc3Npb25zQXJlVmFsaWQobm9kZS5ub2RlLmlkLCByZXN1bHQpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgYXNzZXJ0U3VwcHJlc3Npb25zQXJlVmFsaWQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBzdXBwcmVzc2lvbnM6IE5hZ1BhY2tTdXBwcmVzc2lvbltdXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGVycm9ycyA9IHN1cHByZXNzaW9uc1xuICAgICAgLm1hcChOYWdTdXBwcmVzc2lvbkhlbHBlci5nZXRTdXBwcmVzc2lvbkZvcm1hdEVycm9yKVxuICAgICAgLmZpbHRlcigoZXJyb3JNZXNzYWdlKSA9PiAhIWVycm9yTWVzc2FnZSk7XG5cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgIGAke2lkfTogJHtlcnJvcnMuam9pbihcbiAgICAgICAgICAnJ1xuICAgICAgICApfVxcblNlZSBodHRwczovL2dpdGh1Yi5jb20vY2RrbGFicy9jZGstbmFnI3N1cHByZXNzaW5nLWEtcnVsZSBmb3IgaW5mb3JtYXRpb24gb24gc3VwcHJlc3NpbmcgYSBydWxlLmBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGRvZXNBcHBseShcbiAgICBzdXBwcmVzc2lvbjogTmFnUGFja1N1cHByZXNzaW9uLFxuICAgIHJ1bGVJZDogc3RyaW5nLFxuICAgIGZpbmRpbmdJZDogc3RyaW5nXG4gICk6IGJvb2xlYW4ge1xuICAgIGlmIChydWxlSWQgIT09IHN1cHByZXNzaW9uLmlkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCFzdXBwcmVzc2lvbi5hcHBsaWVzVG8pIHtcbiAgICAgIC8vIHRoZSBydWxlIGlzIG5vdCBncmFudWxhciBzbyBpdCBhbHdheXMgYXBwbGllc1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgZmluZGluZ0lkICYmXG4gICAgICBzdXBwcmVzc2lvbi5hcHBsaWVzVG8uc29tZSgoYXBwbGllc1RvKSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2YgYXBwbGllc1RvID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHJldHVybiBhcHBsaWVzVG8gPT09IGZpbmRpbmdJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCByZWdleCA9IE5hZ1N1cHByZXNzaW9uSGVscGVyLnRvUmVnRXgoYXBwbGllc1RvLnJlZ2V4KTtcbiAgICAgICAgICByZXR1cm4gcmVnZXgudGVzdChmaW5kaW5nSWQpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0U3VwcHJlc3Npb25Gb3JtYXRFcnJvcihcbiAgICBzdXBwcmVzc2lvbjogTmFnUGFja1N1cHByZXNzaW9uXG4gICk6IHN0cmluZyB7XG4gICAgbGV0IGVycm9ycyA9ICcnO1xuICAgIGNvbnN0IGZpbmRpbmcgPSBzdXBwcmVzc2lvbi5pZC5tYXRjaCgvXFxbLipcXF0vKTtcbiAgICBpZiAoZmluZGluZykge1xuICAgICAgZXJyb3JzICs9IGBUaGUgc3VwcHJlc3Npb24gJ2lkJyBjb250YWlucyBhIGZpbmRpbmcgJyR7ZmluZGluZ30uIEEgZmluZGluZyBtdXN0IGJlIHN1cHByZXNzZWQgdXNpbmcgJ2FwcGxpZXNfdG8nLmA7XG4gICAgfVxuICAgIGlmIChzdXBwcmVzc2lvbi5yZWFzb24ubGVuZ3RoIDwgMTApIHtcbiAgICAgIGVycm9ycyArPVxuICAgICAgICBcIlRoZSBzdXBwcmVzc2lvbiBtdXN0IGhhdmUgYSAncmVhc29uJyBvZiAxMCBjaGFyYWN0ZXJzIG9yIG1vcmUuXCI7XG4gICAgfVxuICAgIChzdXBwcmVzc2lvbi5hcHBsaWVzVG8gPz8gW10pLmZvckVhY2goKGFwcGxpZXNUbykgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBhcHBsaWVzVG8gIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgTmFnU3VwcHJlc3Npb25IZWxwZXIudG9SZWdFeChhcHBsaWVzVG8ucmVnZXgpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBlcnJvcnMgKz0gKGVyciBhcyBFcnJvcikubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBlcnJvcnNcbiAgICAgID8gYFxcblxcdEVycm9yKHMpIGRldGVjdGVkIGluIHN1cHByZXNzaW9uIHdpdGggJ2lkJyAke3N1cHByZXNzaW9uLmlkfS4gJHtlcnJvcnN9YFxuICAgICAgOiAnJztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHRvUmVnRXgoczogc3RyaW5nKTogUmVnRXhwIHtcbiAgICB0cnkge1xuICAgICAgLy8gdmVyaWZ5IHRoYXQgdGhlIHJlZ2V4IGlzIGNvcnJlY3RseSBmb3JtYXR0ZWRcbiAgICAgIGNvbnN0IG0gPSBzLm1hdGNoKC9cXC8oLiopXFwvKC4qKT8vKTtcbiAgICAgIGlmICghbSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXcgUmVnRXhwKG1bMV0sIG1bMl0gfHwgJycpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlZ3VsYXIgZXhwcmVzc2lvbiBbJHtzfV1gKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==